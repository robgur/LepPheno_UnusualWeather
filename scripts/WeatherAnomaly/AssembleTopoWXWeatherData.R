library(AOI)
library(climateR)
library(raster)
library(sf)
library(dplyr)

sf::sf_use_s2(FALSE)
test2 <- rnaturalearth::ne_countries(country = c("United States of America", "Mexico", "Canada"),returnclass = "sf")
test2<-st_transform(test2, crs="+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs")
grids = st_make_grid(test2, cellsize = c(250000, 250000))
grids2 = grids[test2]
grids2 = mutate(st_sf(geometry = grids2), id_cells = 1:n())

test <- subset(grids2, id_cells=="161")
AOI <- test
system.time({p4852=getTopoWX(AOI, startDate="1948-01-02", endDate="1952-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p4852_min <- cellStats(p4852$topowx_tmin,mean)
p4852_max <- cellStats(p4852$topowx_tmax,mean)
p4852_min2 <- stack(unlist(p4852_min))
p4852_max2 <- stack(unlist(p4852_max))
p4852_all <- merge(p4852_min2, p4852_max2, by="ind")  
p4852_all_mean <- p4852_all %>% mutate(t_ave=((values.x + values.y)/2))
p4852_all_mean$ind <- gsub("X", "",p4852_all_mean$ind)
p4852_all_mean$ind <- gsub("\\.", "-",p4852_all_mean$ind)

system.time({p5357=getTopoWX(AOI, startDate="1953-01-01", endDate="1957-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p5357_min <- cellStats(p5357$topowx_tmin,mean)
p5357_max <- cellStats(p5357$topowx_tmax,mean)
p5357_min2 <- stack(unlist(p5357_min))
p5357_max2 <- stack(unlist(p5357_max))
p5357_all <- merge(p5357_min2, p5357_max2, by="ind")  
p5357_all_mean <- p5357_all %>% mutate(t_ave=((values.x + values.y)/2))
p5357_all_mean$ind <- gsub("X", "",p5357_all_mean$ind)
p5357_all_mean$ind <- gsub("\\.", "-",p5357_all_mean$ind)

system.time({p5862=getTopoWX(AOI, startDate="1958-01-01", endDate="1962-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p5862_min <- cellStats(p5862$topowx_tmin,mean)
p5862_max <- cellStats(p5862$topowx_tmax,mean)
p5862_min2 <- stack(unlist(p5862_min))
p5862_max2 <- stack(unlist(p5862_max))
p5862_all <- merge(p5862_min2, p5862_max2, by="ind")  
p5862_all_mean <- p5862_all %>% mutate(t_ave=((values.x + values.y)/2))
p5862_all_mean$ind <- gsub("X", "",p5862_all_mean$ind)
p5862_all_mean$ind <- gsub("\\.", "-",p5862_all_mean$ind)

system.time({p6367=getTopoWX(AOI, startDate="1963-01-01", endDate="1967-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p6367_min <- cellStats(p6367$topowx_tmin,mean)
p6367_max <- cellStats(p6367$topowx_tmax,mean)
p6367_min2 <- stack(unlist(p6367_min))
p6367_max2 <- stack(unlist(p6367_max))
p6367_all <- merge(p6367_min2, p6367_max2, by="ind")  
p6367_all_mean <- p6367_all %>% mutate(t_ave=((values.x + values.y)/2))
p6367_all_mean$ind <- gsub("X", "",p6367_all_mean$ind)
p6367_all_mean$ind <- gsub("\\.", "-",p6367_all_mean$ind)

system.time({p6872=getTopoWX(AOI, startDate="1968-01-01", endDate="1972-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p6872_min <- cellStats(p6872$topowx_tmin,mean)
p6872_max <- cellStats(p6872$topowx_tmax,mean)
p6872_min2 <- stack(unlist(p6872_min))
p6872_max2 <- stack(unlist(p6872_max))
p6872_all <- merge(p6872_min2, p6872_max2, by="ind")  
p6872_all_mean <- p6872_all %>% mutate(t_ave=((values.x + values.y)/2))
p6872_all_mean$ind <- gsub("X", "",p6872_all_mean$ind)
p6872_all_mean$ind <- gsub("\\.", "-",p6872_all_mean$ind)

system.time({p7377=getTopoWX(AOI, startDate="1973-01-01", endDate="1977-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p7377_min <- cellStats(p7377$topowx_tmin,mean)
p7377_max <- cellStats(p7377$topowx_tmax,mean)
p7377_min2 <- stack(unlist(p7377_min))
p7377_max2 <- stack(unlist(p7377_max))
p7377_all <- merge(p7377_min2, p7377_max2, by="ind")  
p7377_all_mean <- p7377_all %>% mutate(t_ave=((values.x + values.y)/2))
p7377_all_mean$ind <- gsub("X", "",p7377_all_mean$ind)
p7377_all_mean$ind <- gsub("\\.", "-",p7377_all_mean$ind)

system.time({p7882=getTopoWX(AOI, startDate="1978-01-01", endDate="1982-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p7882_min <- cellStats(p7882$topowx_tmin,mean)
p7882_max <- cellStats(p7882$topowx_tmax,mean)
p7882_min2 <- stack(unlist(p7882_min))
p7882_max2 <- stack(unlist(p7882_max))
p7882_all <- merge(p7882_min2, p7882_max2, by="ind")  
p7882_all_mean <- p7882_all %>% mutate(t_ave=((values.x + values.y)/2))
p7882_all_mean$ind <- gsub("X", "",p7882_all_mean$ind)
p7882_all_mean$ind <- gsub("\\.", "-",p7882_all_mean$ind)

system.time({p8387=getTopoWX(AOI, startDate="1983-01-01", endDate="1987-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p8387_min <- cellStats(p8387$topowx_tmin,mean)
p8387_max <- cellStats(p8387$topowx_tmax,mean)
p8387_min2 <- stack(unlist(p8387_min))
p8387_max2 <- stack(unlist(p8387_max))
p8387_all <- merge(p8387_min2, p8387_max2, by="ind")  
p8387_all_mean <- p8387_all %>% mutate(t_ave=((values.x + values.y)/2))
p8387_all_mean$ind <- gsub("X", "",p8387_all_mean$ind)
p8387_all_mean$ind <- gsub("\\.", "-",p8387_all_mean$ind)

system.time({p8892=getTopoWX(AOI, startDate="1988-01-01", endDate="1992-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p8892_min <- cellStats(p8892$topowx_tmin,mean)
p8892_max <- cellStats(p8892$topowx_tmax,mean)
p8892_min2 <- stack(unlist(p8892_min))
p8892_max2 <- stack(unlist(p8892_max))
p8892_all <- merge(p8892_min2, p8892_max2, by="ind")  
p8892_all_mean <- p8892_all %>% mutate(t_ave=((values.x + values.y)/2))
p8892_all_mean$ind <- gsub("X", "",p8892_all_mean$ind)
p8892_all_mean$ind <- gsub("\\.", "-",p8892_all_mean$ind)

system.time({p9397=getTopoWX(AOI, startDate="1993-01-01", endDate="1997-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p9397_min <- cellStats(p9397$topowx_tmin,mean)
p9397_max <- cellStats(p9397$topowx_tmax,mean)
p9397_min2 <- stack(unlist(p9397_min))
p9397_max2 <- stack(unlist(p9397_max))
p9397_all <- merge(p9397_min2, p9397_max2, by="ind")  
p9397_all_mean <- p9397_all %>% mutate(t_ave=((values.x + values.y)/2))
p9397_all_mean$ind <- gsub("X", "",p9397_all_mean$ind)
p9397_all_mean$ind <- gsub("\\.", "-",p9397_all_mean$ind)

system.time({p9802=getTopoWX(AOI, startDate="1998-01-01", endDate="2002-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p9802_min <- cellStats(p9802$topowx_tmin,mean)
p9802_max <- cellStats(p9802$topowx_tmax,mean)
p9802_min2 <- stack(unlist(p9802_min))
p9802_max2 <- stack(unlist(p9802_max))
p9802_all <- merge(p9802_min2, p9802_max2, by="ind")  
p9802_all_mean <- p9802_all %>% mutate(t_ave=((values.x + values.y)/2))
p9802_all_mean$ind <- gsub("X", "",p9802_all_mean$ind)
p9802_all_mean$ind <- gsub("\\.", "-",p9802_all_mean$ind)

system.time({p0307=getTopoWX(AOI, startDate="2003-01-01", endDate="2007-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p0307_min <- cellStats(p0307$topowx_tmin,mean)
p0307_max <- cellStats(p0307$topowx_tmax,mean)
p0307_min2 <- stack(unlist(p0307_min))
p0307_max2 <- stack(unlist(p0307_max))
p0307_all <- merge(p0307_min2, p0307_max2, by="ind")  
p0307_all_mean <- p0307_all %>% mutate(t_ave=((values.x + values.y)/2))
p0307_all_mean$ind <- gsub("X", "",p0307_all_mean$ind)
p0307_all_mean$ind <- gsub("\\.", "-",p0307_all_mean$ind)

system.time({p0812=getTopoWX(AOI, startDate="2008-01-01", endDate="2012-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p0812_min <- cellStats(p0812$topowx_tmin,mean)
p0812_max <- cellStats(p0812$topowx_tmax,mean)
p0812_min2 <- stack(unlist(p0812_min))
p0812_max2 <- stack(unlist(p0812_max))
p0812_all <- merge(p0812_min2, p0812_max2, by="ind")  
p0812_all_mean <- p0812_all %>% mutate(t_ave=((values.x + values.y)/2))
p0812_all_mean$ind <- gsub("X", "",p0812_all_mean$ind)
p0812_all_mean$ind <- gsub("\\.", "-",p0812_all_mean$ind)

system.time({p1316=getTopoWX(AOI, startDate="2013-01-01", endDate="2016-12-31", param = c('tmax','tmin'), timeRes = "daily")})
p1316_min <- cellStats(p1316$topowx_tmin,mean)
p1316_max <- cellStats(p1316$topowx_tmax,mean)
p1316_min2 <- stack(unlist(p1316_min))
p1316_max2 <- stack(unlist(p1316_max))
p1316_all <- merge(p1316_min2, p1316_max2, by="ind")  
p1316_all_mean <- p1316_all %>% mutate(t_ave=((values.x + values.y)/2))
p1316_all_mean$ind <- gsub("X", "",p1316_all_mean$ind)
p1316_all_mean$ind <- gsub("\\.", "-",p1316_all_mean$ind)

p_allyears_cell161 <- rbind(p4852_all_mean,p5357_all_mean,p5862_all_mean,p6367_all_mean,p6872_all_mean,p7377_all_mean,p7882_all_mean,p8387_all_mean, p8892_all_mean,p9397_all_mean,p9802_all_mean,p0307_all_mean,p0812_all_mean, p1316_all_mean)
p_allyears_cell161 <- cbind(p_allyears_cell161, id_cell='161')
write.csv(p_allyears_cell161, file="p_allyears_cell161.csv")


